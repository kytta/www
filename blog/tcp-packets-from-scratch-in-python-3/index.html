<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>How toÂ build TCP packets from scratch inÂ PythonÂ 3 - Nikita Karamov</title><meta content="

" name=description><link href="/all.css?h=arllksoft9tuQymRJya8tAFM9rImlAafqsbTiJwR0Uo=" media=all rel=stylesheet><link href="/big.css?h=hhVxNCkQeMzbLWVsaU5LCP2QU2d/XoU/nswSqsPwWUg=" media="screen and (min-width: 992px)" rel=stylesheet><link href="/motion.css?h=XeNVtG02qYh86uALfaD8i69x//+e3Lb+wT4RXGN0z5U=" media="screen and not (prefers-reduced-motion)" rel=stylesheet><link media="(prefers-color-scheme: dark)" href=/syntax-theme-dark.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=/syntax-theme-light.css rel=stylesheet><link title="Blog feed" href=https://www.kytta.dev/blog/atom.xml rel=alternate type=application/atom+xml><link href=/favicon.ico rel=icon sizes=any><link href=/icon.svg rel=icon type=image/svg+xml><link href=/apple-touch-icon.png rel=apple-touch-icon><link href=/manifest.webmanifest rel=manifest><meta content=Zola name=generator><body><nav><ul><li class=title><a aria-label="Go to the main page" class=to-main href=/><svg viewbox="0 0 8 8" fill=#c23 height=36 width=36 xmlns=http://www.w3.org/2000/svg><circle cx=2 cy=2 r=1 /><circle cx=6 cy=2 r=1 /><circle cx=2 cy=6 r=1 /><circle cx=6 cy=6 r=1 /><circle cx=4 cy=4 r=1 /><path d="m3.293 3.293 1.414 1.414-2 2-1.414-1.414z"/><path d="m3.293 4.707 1.414-1.414 2 2-1.414 1.414z"/></svg> </a><li><a class=active href=/blog/> Blog </a><li><a href=/uses/> Uses </a><li><a href=/donate/> Donate </a><li><a href=/contact/> Contact </a><li><a href=# id=lift-go-up> â†‘â€…Scroll to top </a></ul></nav><main><h1>How toÂ build TCP packets from scratch inÂ PythonÂ 3</h1><p class=date><time datetime=2020-01-07T00:00:00+00:00> 07 Jan 2020 </time> â€¢ updated 26 Feb 2023<p>One ofÂ the assignments IÂ got atÂ myÂ universityâ€™s ITÂ Security classes was toÂ write aÂ small Python script that would create and send anÂ empty TCP packet with specified flags toÂ the desired host and port combo. This could beÂ easily achieved with <em>scapy</em>, but hereâ€™s the catch â€” weÂ werenâ€™t allowed toÂ use external dependencies for this assignment.<p>Building the packet itself didnâ€™t cause problems, but checksumÂ did. IÂ searched the entire WWW toÂ find answers, but the only thing IÂ found was some spaghetti code that didnâ€™t work (atÂ least inÂ PythonÂ 3). SoÂ IÂ decided toÂ tear down <em>scapy</em> and create aÂ lightweight solution toÂ this exact issue.<p>Letâ€™s get down toÂ business!<h2 id=building-the-packet>Building the packet<a aria-label="Anchor link for: building-the-packet" class=zola-anchor href=#building-the-packet>ğŸ”—</a></h2><p>Letâ€™s create aÂ class <code>TCPPacket</code>, which will hold all the needed packet fields. IÂ will omit theÂ options and data fields.<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-class z-python"><span class="z-storage z-type z-class z-python"><span class="z-keyword z-declaration z-class z-python">class</span></span> <span class="z-entity z-name z-class z-python"><span class="z-meta z-generic-name z-python">TCPPacket</span></span><span class="z-punctuation z-section z-class z-begin z-python">:</span></span>
<span class="z-meta z-function z-python">    <span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-support z-function z-magic z-python">__init__</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-separator z-parameters z-python">,</span>
                 <span class="z-variable z-parameter z-python">src_host</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span>  <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
                 <span class="z-variable z-parameter z-python">src_port</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span>  <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">int</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
                 <span class="z-variable z-parameter z-python">dst_host</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span>  <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">str</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
                 <span class="z-variable z-parameter z-python">dst_port</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span>  <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">int</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-separator z-parameters z-python">,</span>
                 <span class="z-variable z-parameter z-python">flags</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span>     <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">int</span></span> </span><span class="z-meta z-function z-parameters z-default-value z-python"><span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-constant z-numeric z-integer z-decimal z-python">0</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">src_host</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">src_host</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">src_port</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">src_port</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">dst_host</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dst_host</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">dst_port</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dst_port</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">flags</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">flags</span></span>
</span></code></pre><p>Letâ€™s define the <code>build</code> function that will take those fields and encode them into aÂ long bytes sequence.<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">build</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">self</span><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">bytes</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pack</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
        <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">!HHIIBBHHH<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">src_port</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Source Port
</span>        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">dst_port</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Destination Port
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-separator z-arguments z-python">,</span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Sequence Number
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-separator z-arguments z-python">,</span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Acknoledgement Number
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">5</span> <span class="z-keyword z-operator z-comparison z-python"><</span><span class="z-keyword z-operator z-comparison z-python"><</span> <span class="z-constant z-numeric z-integer z-decimal z-python">4</span><span class="z-punctuation z-separator z-arguments z-python">,</span>         <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Data Offset
</span>        <span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">flags</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>     <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Flags
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">8192</span><span class="z-punctuation z-separator z-arguments z-python">,</span>           <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Window
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-separator z-arguments z-python">,</span>              <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Checksum (initial value)
</span>        <span class="z-constant z-numeric z-integer z-decimal z-python">0</span>               <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Urgent pointer
</span>    <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>Here, IÂ use <a rel="nofollow noreferrer" href=https://docs.python.org/3/library/struct.html>the built-in module <code>struct</code></a>. Notice how the Data Offset field isÂ offset (noÂ pun intended) byÂ four bits â€” this isÂ done because, <a rel="nofollow noreferrer" href=https://www.rfc-editor.org/rfc/rfc793#section-3.1>according toÂ the TCP spec</a>, itÂ only takes the first four bits ofÂ the byte, while the rest isÂ reserved.<p>The Checksum field should beÂ left atÂ 0 for now, since itÂ will beÂ calculated later. The other constant parameters can beÂ changed toÂ your liking.<h2 id=calculating-the-checksum>Calculating the checksum<a aria-label="Anchor link for: calculating-the-checksum" class=zola-anchor href=#calculating-the-checksum>ğŸ”—</a></h2><p>WeÂ start byÂ composing aÂ function that will calculate our checksum. The spec tells usÂ the following:<blockquote><p>The checksum field isÂ the 16 bit oneâ€™s complement ofÂ the oneâ€™s complement sum ofÂ all 16 bit words inÂ the header and text.</blockquote><p>IÂ donâ€™t know about you, but IÂ didnâ€™t understand itÂ even after Iâ€™ve read itÂ for the twentieth time. SoÂ instead IÂ referred toÂ <em>scapy</em>â€™s source code and this isÂ what Iâ€™ve composed:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">chksum</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">packet</span></span><span class="z-meta z-function z-parameters z-annotation z-python"><span class="z-punctuation z-separator z-annotation z-parameter z-python">:</span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">bytes</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"> </span><span class="z-meta z-function z-annotation z-return z-python"><span class="z-punctuation z-separator z-annotation z-return z-python">-></span> <span class="z-meta z-qualified-name z-python"><span class="z-support z-type z-python">int</span></span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
    <span class="z-meta z-statement z-conditional z-if z-python"><span class="z-keyword z-control z-conditional z-if z-python">if</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">len</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-arithmetic z-python">%</span> <span class="z-constant z-numeric z-integer z-decimal z-python">2</span> <span class="z-keyword z-operator z-comparison z-python">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-block z-conditional z-if z-python">:</span></span>
        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-python">+=</span> <span class="z-storage z-type z-string z-python">b</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-constant z-character z-escape z-octal z-python">\0</span><span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span>

    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">sum</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">array</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">array</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">H<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-comparison z-python">></span><span class="z-keyword z-operator z-comparison z-python">></span> <span class="z-constant z-numeric z-integer z-decimal z-python">16</span><span class="z-punctuation z-section z-group z-end z-python">)</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-arithmetic z-python">&</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>ffff</span><span class="z-punctuation z-section z-group z-end z-python">)</span></span>
    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-python">+=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span> <span class="z-keyword z-operator z-comparison z-python">></span><span class="z-keyword z-operator z-comparison z-python">></span> <span class="z-constant z-numeric z-integer z-decimal z-python">16</span>

    <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-group z-python"><span class="z-punctuation z-section z-group z-begin z-python">(</span><span class="z-keyword z-operator z-arithmetic z-python">~</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">res</span></span><span class="z-punctuation z-section z-group z-end z-python">)</span></span> <span class="z-keyword z-operator z-arithmetic z-python">&</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>ffff</span>
</span></code></pre><p>This method makes use ofÂ Pythonâ€™s built-in <code>array</code> module, that creates anÂ array with fixed element types. This lets usÂ calculate the sum ofÂ 16-bit words more easily than using aÂ loop. Then the function simply applies some bit arithmetic magic toÂ the sum and returns it.<p>Before weÂ can apply this method toÂ our packet, weÂ need toÂ prepend itÂ with aÂ pseudo-header, that contains extra information, such asÂ IPÂ Addresses and TCP Length. Letâ€™s head back toÂ the <code>build()</code> method and compose the pseudo-header:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pseudo_hdr</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pack</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">!4s4sHH<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">inet_aton</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">src_host</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Source Address
</span>    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">inet_aton</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-language z-python">self</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">dst_host</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>    <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Destination Address
</span>    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">IPPROTO_TCP</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>                 <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> PTCL
</span>    <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">len</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>                         <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> TCP Length
</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>Please note that TCP Length should also include the length ofÂ data sent with the packet. InÂ our case, the data isÂ empty, soÂ weÂ just use the header length.<p>After composing the pseudo-header, weÂ only need toÂ calculate the checksum and insert itÂ back into the packet:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">checksum</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">chksum</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pseudo_hdr</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>

<span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-punctuation z-separator z-slice z-python">:</span><span class="z-constant z-numeric z-integer z-decimal z-python">16</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pack</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">H<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">checksum</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">18</span><span class="z-punctuation z-separator z-slice z-python">:</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span>
</span></code></pre><p>Make sure that the checksum isÂ inserted using the native byte order and not big-endian; this isÂ why there isÂ noÂ exclamation point inÂ the first argument ofÂ <code>struct.pack()</code>.<p>InÂ myÂ example, IÂ simply cut the packet inÂ between and insert the checksum. You can also build the packet from scratch using three consecutive <code>struct.pack</code> calls.<p>The packet isÂ finished, donâ€™t forget to return it:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">packet</span></span>
</span></code></pre><h2 id=sending-the-packet>Sending the packet<a aria-label="Anchor link for: sending-the-packet" class=zola-anchor href=#sending-the-packet>ğŸ”—</a></h2><p>Now letâ€™s make use ofÂ the class weÂ just made and send aÂ TCP Packet. For example, this isÂ how weÂ would create aÂ Christmas Tree Packet (aÂ packet with <code>FIN</code>, <code>URG</code> and <code>PSH</code> flags):<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dst</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">192.168.1.1<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span>

<span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pak</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">TCPPacket</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">192.168.1.42<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
    <span class="z-constant z-numeric z-integer z-decimal z-python">20</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dst</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
    <span class="z-constant z-numeric z-integer z-decimal z-python">666</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
    <span class="z-constant z-numeric z-integer z-binary z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0b</span>000101001</span>  <span class="z-comment z-line z-number-sign z-python"><span class="z-punctuation z-definition z-comment z-python">#</span> Merry Christmas!
</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>ToÂ send this packet, weÂ need toÂ create aÂ socket connection using the TCP protocol:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">s</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">socket</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">AF_INET</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">SOCK_RAW</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">socket</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">IPPROTO_TCP</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>This will add the required IPÂ header for us, soÂ weÂ donâ€™t need toÂ bother building itÂ ourselves.<p>And finally, weÂ send the built packet using theÂ <code>sendto()</code> method:<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">s</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">sendto</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">pak</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">build</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-sequence z-tuple z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">dst</span></span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-decimal z-python">0</span><span class="z-punctuation z-section z-sequence z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><hr><p>The full code (licensed under the GNUÂ GPL 3.0) isÂ <a rel="nofollow noreferrer" href=https://gist.github.com/kytta/b06520e3cb458ac7264cab1c51fa33d6>available asÂ aÂ GitHub Gist</a>. InÂ conclusion, Iâ€™d like toÂ thank the developers ofÂ <a rel="nofollow noreferrer" href=https://scapy.net/><em>scapy</em></a> for being my, umm, â€˜inspirationâ€™ ;)</main><script async defer src=/lift.js></script><script async crossorigin data-goatcounter=https://kytta.goatcounter.com/count integrity=sha384-QGgNMMRFTi8ul5kHJ+vXysPe8gySvSA/Y3rpXZiRLzKPIw8CWY+a3ObKmQsyDr+a src=//gc.zgo.at/count.v3.js></script>